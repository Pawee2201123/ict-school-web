# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–å ±å‘Šæ›¸

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: æ¨¡æ“¬æˆæ¥­äºˆç´„ã‚·ã‚¹ãƒ†ãƒ 
**è©•ä¾¡æ—¥**: 2026å¹´2æœˆ12æ—¥
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: main ãƒ–ãƒ©ãƒ³ãƒ (ã‚³ãƒŸãƒƒãƒˆ: 924289e)
**è©•ä¾¡ç¯„å›²**: Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ï¼ˆGo ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€HTML ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼‰

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡ã‚’å®Ÿæ–½ã—ãŸçµæœã€**é‡å¤§ãªè„†å¼±æ€§ãŒè¤‡æ•°ç™ºè¦‹**ã•ã‚Œã¾ã—ãŸã€‚

### ç·åˆè©•ä¾¡: C+

**å¼·ã¿:**
- SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- bcryptã«ã‚ˆã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ãŒæ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- èªè¨¼ãƒ»èªå¯ã®åˆ†é›¢ãŒé©åˆ‡ã«è¨­è¨ˆã•ã‚Œã¦ã„ã‚‹

**é‡å¤§ãªå•é¡Œç‚¹:**
- âŒ **CSRFä¿è­·ãŒå®Œå…¨ã«æ¬ è½**ï¼ˆæœ€é‡è¦èª²é¡Œï¼‰
- âŒ HTTPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæœªè¨­å®š
- âŒ Cookieã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãŒä¸ååˆ†
- âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã«æ¤œè¨¼ä¸è¶³
- âš ï¸ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã«ç«¶åˆçŠ¶æ…‹ã®å¯èƒ½æ€§

**æ¨å¥¨äº‹é …:**
æœ¬å ±å‘Šæ›¸ã«è¨˜è¼‰ã•ã‚ŒãŸã€Œç·Šæ€¥å¯¾å¿œãŒå¿…è¦ã€ãªé …ç›®ã‚’**ç›´ã¡ã«ä¿®æ­£**ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚ç‰¹ã«CSRFä¿è­·ã®å®Ÿè£…ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®å…¬é–‹å‰ã«å¿…é ˆã§ã™ã€‚

---

## ç›®æ¬¡

1. [èªè¨¼ãƒ»èªå¯æ©Ÿèƒ½](#1-èªè¨¼èªå¯æ©Ÿèƒ½)
2. [SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–](#2-sqlã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–)
3. [å…¥åŠ›å€¤æ¤œè¨¼](#3-å…¥åŠ›å€¤æ¤œè¨¼)
4. [ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†](#4-ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†)
5. [ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰](#5-ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
6. [ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#6-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
7. [HTTPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼](#7-httpã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼)
8. [ç’°å¢ƒå¤‰æ•°ãƒ»ç§˜å¯†æƒ…å ±ç®¡ç†](#8-ç’°å¢ƒå¤‰æ•°ç§˜å¯†æƒ…å ±ç®¡ç†)
9. [ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯](#9-ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯)
10. [ãã®ä»–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‡¸å¿µäº‹é …](#10-ãã®ä»–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‡¸å¿µäº‹é …)
11. [å„ªå…ˆåº¦åˆ¥æ¨å¥¨äº‹é …](#11-å„ªå…ˆåº¦åˆ¥æ¨å¥¨äº‹é …)
12. [ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹](#12-ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹)

---

## 1. èªè¨¼ãƒ»èªå¯æ©Ÿèƒ½

### âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆè‰¯å¥½ãªå¯¾ç­–ï¼‰

#### 1.1 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
**å ´æ‰€**: `internal/auth/password.go`

```go
func HashPassword(pw string) (string, error) {
    b, err := bcrypt.GenerateFromPassword([]byte(pw), bcrypt.DefaultCost)
    return string(b), err
}
```

**è©•ä¾¡**: bcryptã®DefaultCostï¼ˆç¾åœ¨10ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€æ¥­ç•Œæ¨™æº–ã«æº–æ‹ ã—ã¦ã„ã¾ã™ã€‚

#### 1.2 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
**å ´æ‰€**: `internal/auth/session.go`

- `gorilla/securecookie`ã‚’ä½¿ç”¨ã—ãŸæš—å·åŒ–æ¸ˆã¿ã‚¯ãƒƒã‚­ãƒ¼
- ãƒãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã¨ãƒ–ãƒ­ãƒƒã‚¯ã‚­ãƒ¼ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆ
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®æ”¹ã–ã‚“é˜²æ­¢æ©Ÿèƒ½

#### 1.3 äºŒå±¤ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
**å ´æ‰€**: `internal/handlers/middleware.go`

```go
// ç¬¬ä¸€å±¤: ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
func (h *Handler) RequireLogin(next http.HandlerFunc) http.HandlerFunc

// ç¬¬äºŒå±¤: ç®¡ç†è€…æ¨©é™ç¢ºèª
func (h *Handler) RequireAdmin(next http.HandlerFunc) http.HandlerFunc
```

**è©•ä¾¡**: æ¨©é™ç¢ºèªã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§è¡Œã£ã¦ãŠã‚Šã€ã‚¯ãƒƒã‚­ãƒ¼ã®æ”¹ã–ã‚“ã ã‘ã§ã¯ç®¡ç†è€…æ¨©é™ã‚’å–å¾—ã§ããªã„è¨­è¨ˆã€‚

### âŒ è„†å¼±æ€§

#### 1.1 ã€ç·Šæ€¥ã€‘CSRFä¿è­·ã®å®Œå…¨æ¬ è½

**æ·±åˆ»åº¦**: ğŸ”´ **Critical**

**å½±éŸ¿ç¯„å›²**: ã™ã¹ã¦ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ

**è„†å¼±ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `/login` - ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
- `/signup` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
- `/application` - æˆæ¥­ç”³è¾¼
- `/admin/config` - ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå¤‰æ›´
- `/admin/classes/new` - æˆæ¥­ä½œæˆ
- `/admin/reset/execute` - **ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼‰**

**å…·ä½“ä¾‹** (`web/templates/application.html`):
```html
<form action="/application" method="post" class="application-form">
    <input type="hidden" name="session_id" value="{{.Session.SessionID}}">
    <!-- CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒå­˜åœ¨ã—ãªã„ -->
    <button type="submit" class="btn btn-submit">ç”³ã—è¾¼ã¿ã‚’ç¢ºå®šã™ã‚‹</button>
</form>
```

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ª**:
1. æ”»æ’ƒè€…ãŒæ‚ªæ„ã®ã‚ã‚‹ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’ä½œæˆ
2. èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ”»æ’ƒã‚µã‚¤ãƒˆã‚’è¨ªå•
3. æ”»æ’ƒã‚µã‚¤ãƒˆã‹ã‚‰è‡ªå‹•çš„ã«`/application`ã¸POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã—ãªã„æˆæ¥­ç”³è¾¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹

**æœ€æ‚ªã®ã‚±ãƒ¼ã‚¹**:
```html
<!-- æ”»æ’ƒè€…ã®ã‚µã‚¤ãƒˆ -->
<form id="evil" action="https://your-site.com/admin/reset/execute" method="post">
    <input name="confirm_keyword" value="å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹">
</form>
<script>document.getElementById('evil').submit();</script>
```
â†’ ç®¡ç†è€…ãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨**å…¨ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã‚‹**

#### 1.2 Cookieã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šä¸è¶³

**æ·±åˆ»åº¦**: ğŸŸ  **High**

**å ´æ‰€**: `internal/handlers/auth.go:204-212`

```go
c := &http.Cookie{
    Name:     h.sess.Key,
    Value:    encoded,
    Path:     "/",
    HttpOnly: true,
    Expires:  time.Now().Add(24 * time.Hour),
    // Secure: true, // enable in production with HTTPS  â† ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹
    // SameSiteå±æ€§ãŒæœªè¨­å®š
}
```

**å•é¡Œç‚¹**:
- `Secure: false` â†’ HTTPã§ã‚‚ã‚¯ãƒƒã‚­ãƒ¼ãŒé€ä¿¡ã•ã‚Œã‚‹ï¼ˆä¸­é–“è€…æ”»æ’ƒã®ãƒªã‚¹ã‚¯ï¼‰
- `SameSite`æœªè¨­å®š â†’ CSRFæ”»æ’ƒã®ãƒªã‚¹ã‚¯å¢—å¤§

#### 1.3 Cookieã‚­ãƒ¼ã®è„†å¼±ãªç”Ÿæˆ

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**å ´æ‰€**: `internal/handlers/auth.go:29-35`

```go
hash := cfg.CookieHash
if hash == "" {
    hash = string(authRandom(32))  // ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã§å¤‰ã‚ã‚‹
}
```

**å•é¡Œç‚¹**:
- `COOKIE_HASH_KEY`ãŒæœªè¨­å®šã®å ´åˆã€èµ·å‹•æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
- ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã§å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹åŒ–
- ã‚³ãƒ¡ãƒ³ãƒˆã«ã€Œdev onlyã€ã¨ã‚ã‚‹ãŒå¼·åˆ¶ã•ã‚Œã¦ã„ãªã„

---

## 2. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

### âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆå„ªç§€ï¼‰

**è©•ä¾¡**: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã§ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒªã‚¹ã‚¯ã¯**ã‚ã‚Šã¾ã›ã‚“**ã€‚

#### 2.1 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª

**å ´æ‰€**: `internal/models/user.go:54-57`

```go
err := db.QueryRow(
    `SELECT id, email, password_hash, created_at FROM users WHERE email = $1`,
    email,
).Scan(&u.ID, &u.Email, &u.PasswordHash, &u.CreatedAt)
```

#### 2.2 å‹•çš„ã‚¯ã‚¨ãƒªã®å®‰å…¨ãªæ§‹ç¯‰

**å ´æ‰€**: `internal/models/report.go:49-62`

```go
var args []any
argCounter := 1

if classID > 0 {
    query += fmt.Sprintf(" AND c.class_id = $%d", argCounter)
    args = append(args, classID)
    argCounter++
}

rows, err := db.Query(query, args...)
```

**è©•ä¾¡**: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç•ªå·ã®å‹•çš„ç”Ÿæˆã‚‚æ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

#### 2.3 ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®‰å…¨æ€§

**å ´æ‰€**: `internal/models/class.go:20-30`

```go
tx, err := db.Begin()
defer func() {
    if err != nil {
        tx.Rollback()
    } else {
        tx.Commit()
    }
}()
```

**è©•ä¾¡**: ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

## 3. å…¥åŠ›å€¤æ¤œè¨¼

### âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆéƒ¨åˆ†çš„ï¼‰

#### 3.1 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æ¤œè¨¼

**å ´æ‰€**: `web/templates/signup.html`

```javascript
function validateForm() {
    if (!email.includes("@")) {
        alert("æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return false;
    }
    if (password.length < 8) {
        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„");
        return false;
    }
}
```

#### 3.2 ã‚µãƒ¼ãƒãƒ¼å´æ¤œè¨¼

**å ´æ‰€**: `internal/handlers/auth.go:123-126`

```go
if email == "" || pw == "" || studentName == "" || schoolName == "" ||
   grade == "" || guardianName == "" {
    http.Error(w, "invalid input", http.StatusBadRequest)
    return
}
```

### âŒ è„†å¼±æ€§

#### 3.1 ä¸ååˆ†ãªã‚µãƒ¼ãƒãƒ¼å´æ¤œè¨¼

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**å•é¡Œç‚¹**:
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼æ¤œè¨¼ãŒã‚µãƒ¼ãƒãƒ¼å´ã«ãªã„
- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®æœ€å¤§é•·ãƒã‚§ãƒƒã‚¯ãªã—ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã¿ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ãªã—
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼ãŒ`accept="application/pdf"`ã®ã¿ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰

#### 3.2 ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®è„†å¼±æ€§

**æ·±åˆ»åº¦**: ğŸŸ  **High**

**å ´æ‰€**: `internal/handlers/admin.go:185-192`

```go
file, header, err := r.FormFile(formKey)
// MIMEã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼ãªã—
ext := filepath.Ext(header.Filename)  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶å¾¡å¯èƒ½
filename := fmt.Sprintf("syllabus_%d%s", time.Now().Unix(), ext)
```

**å•é¡Œç‚¹**:
- ã‚µãƒ¼ãƒãƒ¼å´ã§ã®MIMEã‚¿ã‚¤ãƒ—æ¤œè¨¼ãŒãªã„
- ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶å¾¡å¯èƒ½
- PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ãƒã‚§ãƒƒã‚¯ãªã—

**æ”»æ’ƒä¾‹**:
```bash
# å®Ÿéš›ã¯å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã ãŒã€.pdfæ‹¡å¼µå­ã§ä¿å­˜ã•ã‚Œã‚‹
curl -F "syllabus=@malware.exe;filename=innocent.pdf" https://site.com/admin/classes/new
```

---

## 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

### âœ… å®Ÿè£…æ¸ˆã¿

#### 4.1 ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™

**å ´æ‰€**: `internal/handlers/auth.go:197`

```go
payload := map[string]any{
    "user_id": u.ID,
    "email":   u.Email,
    "exp":     time.Now().Add(24 * time.Hour).Unix(),
}
```

#### 4.2 æœ‰åŠ¹æœŸé™ã®æ¤œè¨¼

**å ´æ‰€**: `internal/handlers/middleware.go:89-103`

```go
func isSessionValid(data map[string]any) bool {
    expVal, ok := data["exp"]
    if !ok {
        return false
    }
    // è¤‡æ•°ã®å‹ã«å¯¾å¿œï¼ˆint64, float64, stringï¼‰
    return time.Now().Unix() < exp
}
```

### âŒ è„†å¼±æ€§

#### 4.1 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ãªã—

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**å•é¡Œç‚¹**:
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã«æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œãªã„
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¾µå®³æ™‚ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã ã‘ã§ã¯æ”»æ’ƒè€…ã‚’ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ããªã„

#### 4.2 å›ºå®šã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**æ·±åˆ»åº¦**: ğŸŸ¢ **Low**

**å•é¡Œç‚¹**:
- 24æ™‚é–“å›ºå®šã§ã€ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãªã—
- ã€Œãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿æŒã€æ©Ÿèƒ½ãªã—
- ç®¡ç†è€…ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒåŒã˜

#### 4.3 ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Ÿè£…ã®ä¸å®Œå…¨ã•

**å ´æ‰€**: `internal/handlers/auth.go:223-234`

```go
func (h *Handler) Logout(w http.ResponseWriter, r *http.Request) {
    c := &http.Cookie{
        Name:     h.sess.Key,
        Value:    "",
        Path:     "/",
        HttpOnly: true,
        Expires:  time.Unix(0, 0),
        MaxAge:   -1,
        // Secureã¨SameSiteå±æ€§ãŒæ¬ è½
    }
    http.SetCookie(w, c)
}
```

---

## 5. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

### âŒ è„†å¼±æ€§

#### 5.1 ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ãƒªã‚¹ã‚¯

**æ·±åˆ»åº¦**: ğŸŸ¡ **Mediumï¼ˆä½æ¸›ã•ã‚Œã¦ã„ã‚‹ãŒå­˜åœ¨ï¼‰**

**å ´æ‰€**: `internal/handlers/admin.go:205-207`

```go
ext := filepath.Ext(header.Filename)  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¶å¾¡
filename := fmt.Sprintf("syllabus_%d%s", time.Now().Unix(), ext)
dstPath := filepath.Join(uploadDir, filename)
```

**å•é¡Œç‚¹**:
- ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã ãŒã€æ‹¡å¼µå­ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
- `malicious.pdf.exe`ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§`syllabus_1234.pdf.exe`ãŒä¿å­˜ã•ã‚Œã‚‹

#### 5.2 Content-Typeæ¤œè¨¼ãªã—

**æ·±åˆ»åº¦**: ğŸŸ  **High**

**æ¨å¥¨ã•ã‚Œã‚‹å®Ÿè£…**:
```go
// å¿…è¦ãªæ¤œè¨¼
buffer := make([]byte, 512)
_, err := file.Read(buffer)
contentType := http.DetectContentType(buffer)
if contentType != "application/pdf" {
    return errors.New("PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™")
}
```

#### 5.3 èªè¨¼ãªã—ã®ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**å ´æ‰€**: `cmd/server/main.go:43-45`

```go
mux.Handle("/static/", http.StripPrefix("/static/", http.FileServer(http.Dir("./web/static"))))
mux.Handle("/uploads/", http.StripPrefix("/uploads/", http.FileServer(http.Dir(uploadDir))))
```

**å•é¡Œç‚¹**:
- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸPDFã«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãªã—
- URLã‚’çŸ¥ã£ã¦ã„ã‚Œã°èª°ã§ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½

#### 5.4 ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™

**æ·±åˆ»åº¦**: ğŸŸ¢ **Low**

**å ´æ‰€**: `cmd/server/main.go:41`

```go
os.MkdirAll(uploadDir, 0755)  // èª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½
```

**æ¨å¥¨**: `0750`ã¾ãŸã¯`0700`ã«å¤‰æ›´

---

## 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆè‰¯å¥½ï¼‰

#### 6.1 æ±ç”¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

**å ´æ‰€**: `internal/handlers/auth.go:175-177`

```go
u, err := models.GetUserByEmail(h.db, email)
if err != nil {
    http.Error(w, "invalid credentials", http.StatusUnauthorized)
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨æœ‰ç„¡ã‚’æ¼ã‚‰ã•ãªã„
    return
}
```

#### 6.2 å®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ã®ãƒ­ã‚®ãƒ³ã‚°

```go
log.Printf("Signup error: %v", err)  // ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ­ã‚°
http.Error(w, "server error", http.StatusInternalServerError)  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

### âŒ è„†å¼±æ€§

#### 6.1 ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã®æƒ…å ±æ¼æ´©

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**å ´æ‰€**: `internal/handlers/admin.go:70`

```go
if err != nil {
    http.Error(w, "File upload error: "+err.Error(), http.StatusInternalServerError)
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‘ã‚¹ã€æ¨©é™ãªã©ãŒéœ²å‡º
    return
}
```

**å•é¡Œä¾‹**:
```
File upload error: open /var/www/uploads: permission denied
```
â†’ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãŒæ¼æ´©

#### 6.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã®éœ²å‡º

**å ´æ‰€**: `internal/handlers/admin.go:96`

```go
if err != nil {
    http.Error(w, "DB Error: "+err.Error(), http.StatusInternalServerError)
    // ãƒ†ãƒ¼ãƒ–ãƒ«åã€åˆ¶ç´„åã€ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ãŒæ¼æ´©
    return
}
```

---

## 7. HTTPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼

### âŒ ã€ç·Šæ€¥ã€‘å®Œå…¨ã«æ¬ è½

**æ·±åˆ»åº¦**: ğŸ”´ **Critical**

**ç¾çŠ¶**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒ**ä¸€åˆ‡è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“**ã€‚

```bash
$ grep -r "X-Frame-Options\|X-Content-Type\|Content-Security" --include="*.go"
# çµæœãªã—
```

### æ¬ è½ã—ã¦ã„ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼

| ãƒ˜ãƒƒãƒ€ãƒ¼ | åŠ¹æœ | æœªè¨­å®šæ™‚ã®ãƒªã‚¹ã‚¯ |
|---------|------|----------------|
| `X-Frame-Options` | iframeåŸ‹ã‚è¾¼ã¿é˜²æ­¢ | ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°æ”»æ’ƒ |
| `X-Content-Type-Options` | MIMEã‚¿ã‚¤ãƒ—ã®æ¨æ¸¬é˜²æ­¢ | MIMEæ··åŒæ”»æ’ƒ |
| `Content-Security-Policy` | XSSæ”»æ’ƒç·©å’Œ | ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚° |
| `Strict-Transport-Security` | HTTPSå¼·åˆ¶ | ä¸­é–“è€…æ”»æ’ƒ |
| `X-XSS-Protection` | ãƒ–ãƒ©ã‚¦ã‚¶XSSé˜²å¾¡ | ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ–ãƒ©ã‚¦ã‚¶ã§è„†å¼± |
| `Referrer-Policy` | ãƒªãƒ•ã‚¡ãƒ©ãƒ¼æƒ…å ±åˆ¶å¾¡ | æƒ…å ±æ¼æ´© |

### æ”»æ’ƒã‚·ãƒŠãƒªã‚ªä¾‹

**ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°**:
```html
<!-- æ”»æ’ƒè€…ã®ã‚µã‚¤ãƒˆ -->
<iframe src="https://your-site.com/admin/reset" style="opacity:0"></iframe>
<button style="position:absolute">ç„¡æ–™ã‚®ãƒ•ãƒˆã‚’ã‚²ãƒƒãƒˆ</button>
<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¤ã‚‚ã‚ŠãŒã€å®Ÿéš›ã¯ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ -->
```

---

## 8. ç’°å¢ƒå¤‰æ•°ãƒ»ç§˜å¯†æƒ…å ±ç®¡ç†

### âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆè‰¯å¥½ï¼‰

#### 8.1 é›†ä¸­ç®¡ç†ã•ã‚ŒãŸè¨­å®š

**å ´æ‰€**: `internal/config/config.go`

```go
func Load() Config {
    return Config{
        DB_DSN:      getDatabaseDSN(),
        CookieHash:  getEnv("COOKIE_HASH_KEY", ""),
        CookieBlock: getEnv("COOKIE_BLOCK_KEY", ""),
        SMTPPassword: getEnv("SMTP_PASSWORD", ""),
    }
}
```

#### 8.2 .envãƒ•ã‚¡ã‚¤ãƒ«ä¿è­·

- `.env.example`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæä¾›
- `.gitignore`ã§`.env`ã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‹ã‚‰é™¤å¤–

### âŒ è„†å¼±æ€§

#### 8.1 ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®è„†å¼±ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**å ´æ‰€**: `.env.example`

```bash
ADMIN_PASSWORD=admin1234  # è„†å¼±ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
```

**å•é¡Œç‚¹**: é–‹ç™ºè€…ãŒã“ã®ã¾ã¾æœ¬ç•ªç’°å¢ƒã§ä½¿ç”¨ã™ã‚‹å¯èƒ½æ€§

#### 8.2 å¿…é ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ¤œè¨¼ãªã—

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**æ¨å¥¨ã•ã‚Œã‚‹å®Ÿè£…**:
```go
if cfg.CookieHash == "" && isProduction() {
    log.Fatal("COOKIE_HASH_KEY is required in production")
}
```

#### 8.3 SMTPèªè¨¼æƒ…å ±ã®å¹³æ–‡ä¿å­˜

**æ·±åˆ»åº¦**: ğŸŸ¢ **Low**

**å•é¡Œç‚¹**:
- ç’°å¢ƒå¤‰æ•°ã«å¹³æ–‡ä¿å­˜
- `ps aux`ã§ãƒ—ãƒ­ã‚»ã‚¹ãƒªã‚¹ãƒˆã‹ã‚‰è¦‹ãˆã‚‹å¯èƒ½æ€§

---

## 9. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯

### âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆè‰¯å¥½ï¼‰

#### 9.1 ç”³è¾¼åˆ¶é™

**å ´æ‰€**: `internal/models/enrollment.go:103-158`

```go
func CheckEnrollmentLimits(db *sql.DB, userID, newSessionID int) error {
    // åˆè¨ˆ3ã‚¯ãƒ©ã‚¹ã¾ã§
    if totalCount >= 3 {
        return ErrTotalLimitExceeded
    }
    // 1æ—¥2ã‚¯ãƒ©ã‚¹ã¾ã§
    if dayCounts[newDaySequence] >= 2 {
        return ErrDayLimitExceeded
    }
    return nil
}
```

### âŒ è„†å¼±æ€§

#### 9.1 ã€é‡è¦ã€‘ç”³è¾¼å‡¦ç†ã®ç«¶åˆçŠ¶æ…‹

**æ·±åˆ»åº¦**: ğŸŸ  **High**

**å ´æ‰€**: `internal/models/enrollment.go:26-35`

```go
// ã‚¹ãƒ†ãƒƒãƒ—1: å®šå“¡ç¢ºèª
var current, cap int
err := db.QueryRow("SELECT current_enrolled_count, capacity FROM class_sessions WHERE session_id = $1", sessionID).Scan(&current, &cap)
if current >= cap {
    return ErrSessionFull
}

// ã‚¹ãƒ†ãƒƒãƒ—2: ç”³è¾¼æŒ¿å…¥ï¼ˆåˆ¥ã‚¯ã‚¨ãƒªï¼‰
err = db.QueryRow(query, sessionID, userID).Scan(&enrollmentID)

// ã‚¹ãƒ†ãƒƒãƒ—3: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°ï¼ˆåˆ¥ã‚¯ã‚¨ãƒªï¼‰
if err == nil {
    _, _ = db.Exec("UPDATE class_sessions SET current_enrolled_count = current_enrolled_count + 1...")
}
```

**å•é¡Œç‚¹**:
- 3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚¢ãƒˆãƒŸãƒƒã‚¯ã§ãªã„
- 2äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ™‚ã«ã‚¹ãƒ†ãƒƒãƒ—1ã‚’é€šéã™ã‚‹å¯èƒ½æ€§
- å®šå“¡ã‚ªãƒ¼ãƒãƒ¼ã«ãªã‚‹å¯èƒ½æ€§

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ª**:
```
æ™‚åˆ»  ãƒ¦ãƒ¼ã‚¶ãƒ¼A               ãƒ¦ãƒ¼ã‚¶ãƒ¼B               ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
T1    å®šå“¡ç¢ºèª (9/10)                              current=9
T2                          å®šå“¡ç¢ºèª (9/10)         current=9
T3    ç”³è¾¼å®Ÿè¡Œ                                     current=10
T4                          ç”³è¾¼å®Ÿè¡Œ                current=11  â† å®šå“¡ã‚ªãƒ¼ãƒãƒ¼!
```

**ä¿®æ­£æ–¹æ³•**:
```go
tx, _ := db.Begin()
// è¡Œãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯
var current, cap int
tx.QueryRow("SELECT current_enrolled_count, capacity FROM class_sessions WHERE session_id = $1 FOR UPDATE", sessionID).Scan(&current, &cap)
if current >= cap {
    tx.Rollback()
    return ErrSessionFull
}
// ã‚¢ãƒˆãƒŸãƒƒã‚¯ã«æŒ¿å…¥ã¨æ›´æ–°
tx.Exec(...)
tx.Commit()
```

#### 9.2 ç®¡ç†è€…ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã®å±é™ºæ€§

**æ·±åˆ»åº¦**: ğŸ”´ **Critical**

**å ´æ‰€**: `internal/handlers/admin_reset.go:23-27`

```go
keyword := r.FormValue("confirm_keyword")
if keyword != "å‰Šé™¤ã‚’å®Ÿè¡Œã™ã‚‹" {
    http.Error(w, "ç¢ºèªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“", http.StatusBadRequest)
    return
}
// ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
```

**å•é¡Œç‚¹**:
- CSRFä¿è­·ãªã—ï¼ˆã“ã®æ©Ÿèƒ½ã§ã¯ç‰¹ã«å±é™ºï¼‰
- å®Ÿè¡Œè€…ã®ç›£æŸ»ãƒ­ã‚°ãªã—
- å‰Šé™¤å‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªãªã—
- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1ã¤ã ã‘ãŒä¿è­·æ‰‹æ®µ

---

## 10. ãã®ä»–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‡¸å¿µäº‹é …

### 10.1 ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ãƒ‘ãƒ‹ãƒƒã‚¯ãƒªã‚¹ã‚¯

**æ·±åˆ»åº¦**: ğŸŸ¢ **Low**

**å ´æ‰€**: `internal/handlers/student.go:198-202`

```go
go func() {
    if err := h.sendEnrollmentEmail(userID, sessID, data["email"].(string)); err != nil {
        // å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã™ã‚‹ã¨ãƒ‘ãƒ‹ãƒƒã‚¯
    }
}()
```

**ä¿®æ­£**:
```go
email, ok := data["email"].(string)
if !ok {
    log.Printf("Invalid email type in session data")
    return
}
```

### 10.2 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**æ¬ è½ã—ã¦ã„ã‚‹ä¿è­·**:
- ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹é˜²æ­¢ãªã—
- ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãªã—
- APIãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—

**æ”»æ’ƒä¾‹**:
```bash
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç·å½“ãŸã‚Šæ”»æ’ƒ
for pass in $(cat passwords.txt); do
    curl -X POST https://site.com/login -d "email=admin@example.com&password=$pass"
done
```

### 10.3 ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®JavaScriptã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**å ´æ‰€**: `web/templates/application.html:11-13`

```html
<script>
    alert('{{.Error}}');
</script>
```

**å•é¡Œç‚¹**:
- Goã®HTML escapeã¯HTML ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”¨
- JavaScriptã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ç•°ãªã‚‹ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãŒå¿…è¦
- `.Error`ã«`</script><script>alert('xss')`ãŒå«ã¾ã‚Œã‚‹ã¨å±é™º

**æ¨å¥¨**:
```html
<script>
    alert({{. | js}});  // JavaScriptã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
</script>
```

---

## 11. å„ªå…ˆåº¦åˆ¥æ¨å¥¨äº‹é …

### ğŸ”´ ç·Šæ€¥ï¼ˆç›´ã¡ã«å¯¾å¿œï¼‰

#### 1. CSRFä¿è­·ã®å®Ÿè£…

**å½±éŸ¿**: ã™ã¹ã¦ã®çŠ¶æ…‹å¤‰æ›´æ“ä½œ

**å®Ÿè£…æ–¹æ³•**:
```bash
go get github.com/gorilla/csrf
```

**å·¥æ•°**: 4-6æ™‚é–“

**è©³ç´°**: [ã‚»ã‚¯ã‚·ãƒ§ãƒ³12.1](#121-csrfä¿è­·ã®å®Ÿè£…) å‚ç…§

---

#### 2. Cookieã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ©ã‚°ã®æœ‰åŠ¹åŒ–

**å½±éŸ¿**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯é˜²æ­¢

**å¤‰æ›´ç®‡æ‰€**: `internal/handlers/auth.go:204-212`

**å·¥æ•°**: 30åˆ†

**è©³ç´°**: [ã‚»ã‚¯ã‚·ãƒ§ãƒ³12.2](#122-cookieã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š) å‚ç…§

---

#### 3. HTTPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ 

**å½±éŸ¿**: XSSã€ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°é˜²æ­¢

**å·¥æ•°**: 2-3æ™‚é–“

**è©³ç´°**: [ã‚»ã‚¯ã‚·ãƒ§ãƒ³12.3](#123-httpã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼) å‚ç…§

---

#### 4. ç”³è¾¼ç«¶åˆçŠ¶æ…‹ã®ä¿®æ­£

**å½±éŸ¿**: å®šå“¡ç®¡ç†ã®æ­£ç¢ºæ€§

**å¤‰æ›´ç®‡æ‰€**: `internal/models/enrollment.go`

**å·¥æ•°**: 3-4æ™‚é–“

**è©³ç´°**: [ã‚»ã‚¯ã‚·ãƒ§ãƒ³12.4](#124-ç”³è¾¼å‡¦ç†ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¿®æ­£) å‚ç…§

---

### ğŸŸ  é«˜å„ªå…ˆåº¦ï¼ˆä»Šé€±ä¸­ã«å¯¾å¿œï¼‰

#### 5. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¤œè¨¼

**å®Ÿè£…å†…å®¹**:
- ã‚µãƒ¼ãƒãƒ¼å´MIMEã‚¿ã‚¤ãƒ—æ¤œè¨¼
- ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ
- PDFãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ãƒã‚§ãƒƒã‚¯

**å·¥æ•°**: 3-4æ™‚é–“

---

#### 6. å¼·åŠ›ãªCookieã‚­ãƒ¼ã®å¼·åˆ¶

**å®Ÿè£…å†…å®¹**:
```go
if cfg.CookieHash == "" && os.Getenv("GO_ENV") == "production" {
    log.Fatal("COOKIE_HASH_KEY must be set in production")
}
```

**å·¥æ•°**: 1æ™‚é–“

---

#### 7. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…

**å¯¾è±¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- `/login` - 5å›/åˆ†
- `/signup` - 3å›/10åˆ†
- `/application` - 10å›/æ™‚é–“

**æ¨å¥¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `golang.org/x/time/rate`

**å·¥æ•°**: 4-6æ™‚é–“

---

#### 8. ç›£æŸ»ãƒ­ã‚°ã®è¿½åŠ 

**ãƒ­ã‚°å¯¾è±¡**:
- ã™ã¹ã¦ã®ç®¡ç†è€…æ“ä½œ
- èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
- ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ

**å·¥æ•°**: 4-5æ™‚é–“

---

### ğŸŸ¡ ä¸­å„ªå…ˆåº¦ï¼ˆæ¬¡ã‚¹ãƒ—ãƒªãƒ³ãƒˆï¼‰

#### 9. å…¥åŠ›å€¤æ¤œè¨¼ã®å¼·åŒ–

**å®Ÿè£…å†…å®¹**:
- ã‚µãƒ¼ãƒãƒ¼å´ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¤œè¨¼
- ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
- æœ€å¤§é•·ã®å¼·åˆ¶

**å·¥æ•°**: 6-8æ™‚é–“

---

#### 10. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æ”¹å–„

**å®Ÿè£…å†…å®¹**:
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
- ç®¡ç†è€…ç”¨ã®çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚»ãƒƒã‚·ãƒ§ãƒ³

**å·¥æ•°**: 5-6æ™‚é–“

---

## 12. ä¿®æ­£ã‚³ãƒ¼ãƒ‰ä¾‹

### 12.1 CSRFä¿è­·ã®å®Ÿè£…

#### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
go get github.com/gorilla/csrf
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: main.goã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `cmd/server/main.go`

```go
package main

import (
    "github.com/gorilla/csrf"
    // ... æ—¢å­˜ã®import
)

func main() {
    // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰

    // CSRFä¿è­·ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¿½åŠ 
    csrfKey := []byte(cfg.CookieHash) // 32ãƒã‚¤ãƒˆã¾ãŸã¯64ãƒã‚¤ãƒˆ
    CSRF := csrf.Protect(
        csrfKey,
        csrf.Secure(true),              // HTTPSå¿…é ˆ
        csrf.Path("/"),
        csrf.SameSite(csrf.SameSiteStrictMode),
    )

    // ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒˆã«é©ç”¨
    http.ListenAndServe(":8080", CSRF(mux))
}
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä¿®æ­£

**ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã«è¿½åŠ **:

```html
<form action="/application" method="post">
    {{ .csrfField }}  <!-- CSRFãƒˆãƒ¼ã‚¯ãƒ³ -->
    <input type="hidden" name="session_id" value="{{.Session.SessionID}}">
    <button type="submit">ç”³ã—è¾¼ã¿ã‚’ç¢ºå®šã™ã‚‹</button>
</form>
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `internal/handlers/student.go`

```go
func (h *Handler) StudentApplication(w http.ResponseWriter, r *http.Request) {
    // ...æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰

    data := map[string]any{
        "Session": session,
        "csrfField": csrf.TemplateField(r),  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã™
    }
    h.tpl.Render(w, "application.html", data)
}
```

---

### 12.2 Cookieã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

**ãƒ•ã‚¡ã‚¤ãƒ«**: `internal/handlers/auth.go`

```go
func (h *Handler) Login(w http.ResponseWriter, r *http.Request) {
    // ... æ—¢å­˜ã®èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯

    c := &http.Cookie{
        Name:     h.sess.Key,
        Value:    encoded,
        Path:     "/",
        HttpOnly: true,
        Secure:   true,  // â† ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
        SameSite: http.SameSiteStrictMode,  // â† è¿½åŠ 
        Expires:  time.Now().Add(24 * time.Hour),
    }
    http.SetCookie(w, c)
}

func (h *Handler) Logout(w http.ResponseWriter, r *http.Request) {
    c := &http.Cookie{
        Name:     h.sess.Key,
        Value:    "",
        Path:     "/",
        HttpOnly: true,
        Secure:   true,  // â† è¿½åŠ 
        SameSite: http.SameSiteStrictMode,  // â† è¿½åŠ 
        Expires:  time.Unix(0, 0),
        MaxAge:   -1,
    }
    http.SetCookie(w, c)
}
```

**ç’°å¢ƒå¤‰æ•°ã®è¿½åŠ **: `.env`

```bash
# 32ãƒã‚¤ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ ã‚­ãƒ¼ç”Ÿæˆ
openssl rand -hex 32

# .envã«è¿½åŠ 
COOKIE_HASH_KEY=<ç”Ÿæˆã•ã‚ŒãŸ64æ–‡å­—ã®16é€²æ•°æ–‡å­—åˆ—>
```

---

### 12.3 HTTPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼

#### æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `internal/handlers/security.go`

```go
package handlers

import "net/http"

// SecurityHeadersMiddleware ã¯æ¨™æº–çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
func SecurityHeadersMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        // ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°é˜²æ­¢
        w.Header().Set("X-Frame-Options", "DENY")

        // MIMEæ··åŒæ”»æ’ƒé˜²æ­¢
        w.Header().Set("X-Content-Type-Options", "nosniff")

        // XSSæ”»æ’ƒç·©å’Œ
        w.Header().Set("Content-Security-Policy",
            "default-src 'self'; "+
            "script-src 'self' 'unsafe-inline'; "+
            "style-src 'self' 'unsafe-inline'; "+
            "img-src 'self' data:; "+
            "font-src 'self'; "+
            "connect-src 'self'; "+
            "frame-ancestors 'none'")

        // HTTPSå¼·åˆ¶ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
        if r.TLS != nil {
            w.Header().Set("Strict-Transport-Security",
                "max-age=31536000; includeSubDomains; preload")
        }

        // ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ–ãƒ©ã‚¦ã‚¶ã®XSSä¿è­·
        w.Header().Set("X-XSS-Protection", "1; mode=block")

        // ãƒªãƒ•ã‚¡ãƒ©ãƒ¼åˆ¶å¾¡
        w.Header().Set("Referrer-Policy", "strict-origin-when-cross-origin")

        next.ServeHTTP(w, r)
    })
}
```

#### main.goã¸ã®é©ç”¨

**ãƒ•ã‚¡ã‚¤ãƒ«**: `cmd/server/main.go`

```go
func main() {
    // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é©ç”¨
    secureHandler := handlers.SecurityHeadersMiddleware(mux)

    http.ListenAndServe(":8080", secureHandler)
}
```

---

### 12.4 ç”³è¾¼å‡¦ç†ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `internal/models/enrollment.go`

```go
func EnrollUser(db *sql.DB, sessionID, userID int) error {
    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    tx, err := db.Begin()
    if err != nil {
        return err
    }
    defer func() {
        if err != nil {
            tx.Rollback()
        }
    }()

    // è¡Œãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ã§å®šå“¡ç¢ºèª
    var current, cap int
    err = tx.QueryRow(`
        SELECT current_enrolled_count, capacity
        FROM class_sessions
        WHERE session_id = $1
        FOR UPDATE  -- è¡Œãƒ­ãƒƒã‚¯
    `, sessionID).Scan(&current, &cap)

    if err != nil {
        return err
    }

    // å®šå“¡ãƒã‚§ãƒƒã‚¯
    if current >= cap {
        return ErrSessionFull
    }

    // ç”³è¾¼æŒ¿å…¥
    var enrollmentID int
    err = tx.QueryRow(`
        INSERT INTO session_enrollments (session_id, user_id, enrolled_at)
        VALUES ($1, $2, NOW())
        RETURNING enrollment_id
    `, sessionID, userID).Scan(&enrollmentID)

    if err != nil {
        return err
    }

    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
    _, err = tx.Exec(`
        UPDATE class_sessions
        SET current_enrolled_count = current_enrolled_count + 1
        WHERE session_id = $1
    `, sessionID)

    if err != nil {
        return err
    }

    // ã‚³ãƒŸãƒƒãƒˆ
    err = tx.Commit()
    return err
}
```

**é‡è¦**: `FOR UPDATE`ã«ã‚ˆã‚Šã€åŒã˜session_idã®è¡Œã‚’èª­ã¿å–ã‚ã†ã¨ã™ã‚‹ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ãƒ­ãƒƒã‚¯ãŒè§£æ”¾ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿã—ã¾ã™ã€‚

---

### 12.5 ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¤œè¨¼ã®å¼·åŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**: `internal/handlers/admin.go`

```go
import (
    "net/http"
    "path/filepath"
    "strings"
)

// è¨±å¯ã•ã‚Œã‚‹æ‹¡å¼µå­ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆ
var allowedExtensions = map[string]bool{
    ".pdf": true,
}

func (h *Handler) handleFileUpload(r *http.Request, formKey string) (string, error) {
    file, header, err := r.FormFile(formKey)
    if err != nil {
        if err == http.ErrMissingFile {
            return "", nil
        }
        return "", err
    }
    defer file.Close()

    // 1. ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã®ãƒã‚§ãƒƒã‚¯
    ext := strings.ToLower(filepath.Ext(header.Filename))
    if !allowedExtensions[ext] {
        return "", errors.New("PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™")
    }

    // 2. MIMEã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼
    buffer := make([]byte, 512)
    _, err = file.Read(buffer)
    if err != nil {
        return "", err
    }

    contentType := http.DetectContentType(buffer)
    if contentType != "application/pdf" {
        return "", errors.New("ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒç„¡åŠ¹ã§ã™ã€‚PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„")
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚¤ãƒ³ã‚¿ã‚’å…ˆé ­ã«æˆ»ã™
    file.Seek(0, 0)

    // 3. PDFãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ã®ãƒã‚§ãƒƒã‚¯
    header := make([]byte, 4)
    _, err = file.Read(header)
    if err != nil {
        return "", err
    }
    if string(header) != "%PDF" {
        return "", errors.New("ç„¡åŠ¹ãªPDFãƒ•ã‚¡ã‚¤ãƒ«ã§ã™")
    }
    file.Seek(0, 0)

    // 4. ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆï¼ˆæ‹¡å¼µå­ã‚’å¼·åˆ¶ï¼‰
    filename := fmt.Sprintf("syllabus_%d.pdf", time.Now().Unix())
    dstPath := filepath.Join(h.uploadDir, filename)

    // 5. ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
    dst, err := os.Create(dstPath)
    if err != nil {
        return "", err
    }
    defer dst.Close()

    if _, err = io.Copy(dst, file); err != nil {
        os.Remove(dstPath)  // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å‰Šé™¤
        return "", err
    }

    return filename, nil
}
```

---

### 12.6 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…

#### æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `internal/middleware/ratelimit.go`

```go
package middleware

import (
    "net/http"
    "sync"
    "time"
    "golang.org/x/time/rate"
)

// IPãƒ™ãƒ¼ã‚¹ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
type IPRateLimiter struct {
    ips map[string]*rate.Limiter
    mu  *sync.RWMutex
    r   rate.Limit
    b   int
}

func NewIPRateLimiter(r rate.Limit, b int) *IPRateLimiter {
    return &IPRateLimiter{
        ips: make(map[string]*rate.Limiter),
        mu:  &sync.RWMutex{},
        r:   r,
        b:   b,
    }
}

func (i *IPRateLimiter) GetLimiter(ip string) *rate.Limiter {
    i.mu.Lock()
    defer i.mu.Unlock()

    limiter, exists := i.ips[ip]
    if !exists {
        limiter = rate.NewLimiter(i.r, i.b)
        i.ips[ip] = limiter
    }

    return limiter
}

func (i *IPRateLimiter) Limit(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        ip := r.RemoteAddr
        limiter := i.GetLimiter(ip)

        if !limiter.Allow() {
            http.Error(w, "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚",
                http.StatusTooManyRequests)
            return
        }

        next.ServeHTTP(w, r)
    })
}
```

#### main.goã¸ã®é©ç”¨

```go
import "example.com/myapp/internal/middleware"

func main() {
    // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰

    // ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ1åˆ†é–“ã«5å›ï¼‰
    loginLimiter := middleware.NewIPRateLimiter(rate.Every(12*time.Second), 5)
    mux.Handle("/login", loginLimiter.Limit(http.HandlerFunc(h.Login)))

    // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ10åˆ†é–“ã«3å›ï¼‰
    signupLimiter := middleware.NewIPRateLimiter(rate.Every(200*time.Second), 3)
    mux.Handle("/signup", signupLimiter.Limit(http.HandlerFunc(h.Signup)))
}
```

---

### 12.7 ç›£æŸ»ãƒ­ã‚°ã®å®Ÿè£…

#### æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `internal/audit/logger.go`

```go
package audit

import (
    "database/sql"
    "log"
    "time"
)

type Event struct {
    UserID    int
    Action    string
    Resource  string
    IPAddress string
    Success   bool
    Details   string
}

func Log(db *sql.DB, event Event) {
    _, err := db.Exec(`
        INSERT INTO audit_logs
        (user_id, action, resource, ip_address, success, details, created_at)
        VALUES ($1, $2, $3, $4, $5, $6, $7)
    `,
        event.UserID,
        event.Action,
        event.Resource,
        event.IPAddress,
        event.Success,
        event.Details,
        time.Now(),
    )

    if err != nil {
        log.Printf("Failed to write audit log: %v", err)
    }
}
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒè¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `init.sql`

```sql
CREATE TABLE IF NOT EXISTS audit_logs (
    log_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id),
    action VARCHAR(50) NOT NULL,
    resource VARCHAR(100),
    ip_address VARCHAR(45),
    success BOOLEAN DEFAULT true,
    details TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_audit_user ON audit_logs(user_id);
CREATE INDEX idx_audit_action ON audit_logs(action);
CREATE INDEX idx_audit_created ON audit_logs(created_at);
```

#### ä½¿ç”¨ä¾‹

```go
import "example.com/myapp/internal/audit"

func (h *Handler) AdminResetExecute(w http.ResponseWriter, r *http.Request) {
    userID := r.Context().Value(sessionKey).(map[string]any)["user_id"].(int)

    // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
    audit.Log(h.db, audit.Event{
        UserID:    userID,
        Action:    "SYSTEM_RESET",
        Resource:  "all_data",
        IPAddress: r.RemoteAddr,
        Success:   true,
        Details:   "Full system reset executed",
    })

    // ãƒªã‚»ãƒƒãƒˆå‡¦ç†...
}
```

---

## 13. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã‚·ã‚¹ãƒ†ãƒ ã‚’æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] **CSRFä¿è­·ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹**
  - ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒå«ã¾ã‚Œã‚‹
  - gorilla/csrfãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹

- [ ] **CookieãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹**
  - `Secure: true` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
  - `SameSite: Strict` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
  - `COOKIE_HASH_KEY` ãŒç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹

- [ ] **HTTPã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹**
  - X-Frame-Options: DENY
  - X-Content-Type-Options: nosniff
  - Content-Security-Policy ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
  - Strict-Transport-Security ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ï¼ˆHTTPSç’°å¢ƒï¼‰

- [ ] **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒé©åˆ‡**
  - ç”³è¾¼å‡¦ç†ã§ `FOR UPDATE` ã‚’ä½¿ç”¨
  - ç«¶åˆçŠ¶æ…‹ãŒãªã„ã“ã¨ã‚’ç¢ºèª

- [ ] **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®‰å…¨**
  - MIMEã‚¿ã‚¤ãƒ—æ¤œè¨¼ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
  - ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ãŒãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæ–¹å¼
  - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ãŒ `0750` ä»¥ä¸‹

- [ ] **ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹**
  - `.env` ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœ¬ç•ªç”¨ã®å€¤ã§è¨­å®šã•ã‚Œã¦ã„ã‚‹
  - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
  - SMTPèªè¨¼æƒ…å ±ãŒæ­£ã—ã„

- [ ] **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒæœ‰åŠ¹**
  - ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é©ç”¨
  - ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é©ç”¨

- [ ] **ç›£æŸ»ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹**
  - ç®¡ç†è€…æ“ä½œãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹
  - ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆå®Ÿè¡ŒãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹

- [ ] **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ±ç”¨åŒ–ã•ã‚Œã¦ã„ã‚‹**
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ãŒéœ²å‡ºã—ã¦ã„ãªã„
  - ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ãŒéœ²å‡ºã—ã¦ã„ãªã„

- [ ] **HTTPS ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹**
  - SSL/TLSè¨¼æ˜æ›¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹
  - HTTP â†’ HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹

---

## 14. ç¶™ç¶šçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

### æ¨å¥¨ã•ã‚Œã‚‹å®šæœŸçš„ãªå¯¾ç­–

#### æœˆæ¬¡
- [ ] ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (`go list -m all | nancy sleuth`)
- [ ] ç›£æŸ»ãƒ­ã‚°ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
- [ ] å¤±æ•—ã—ãŸãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã®åˆ†æ

#### å››åŠæœŸ
- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã®è¦‹ç›´ã—
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®é©ç”¨
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©æ—§ãƒ†ã‚¹ãƒˆ

#### å¹´æ¬¡
- [ ] å¤–éƒ¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- [ ] ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œè¨ˆç”»ã®æ›´æ–°

### æ¨å¥¨ãƒ„ãƒ¼ãƒ«

```bash
# ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
go install github.com/sonatype-nexus-community/nancy@latest
go list -m all | nancy sleuth

# é™çš„è§£æ
go install github.com/securego/gosec/v2/cmd/gosec@latest
gosec ./...

# Linter
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
golangci-lint run
```

---

## 15. é€£çµ¡å…ˆãƒ»å‚è€ƒè³‡æ–™

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã®å ±å‘Š

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’ç™ºè¦‹ã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§å ±å‘Šã—ã¦ãã ã•ã„:

1. **å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªã«ã¯æŠ•ç¨¿ã—ãªã„**
2. é–‹ç™ºãƒãƒ¼ãƒ ã«ç›´æ¥é€£çµ¡ï¼ˆãƒ¡ãƒ¼ãƒ«æ¨å¥¨ï¼‰
3. å•é¡Œã®è©³ç´°ã€å†ç¾æ‰‹é †ã€å½±éŸ¿ç¯„å›²ã‚’å«ã‚ã‚‹

### å‚è€ƒè³‡æ–™

- [OWASP Top 10 2021](https://owasp.org/www-project-top-ten/)
- [Go Security Best Practices](https://github.com/OWASP/Go-SCP)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)
- [CWE Top 25](https://cwe.mitre.org/top25/)

---

## ä»˜éŒ²A: è„†å¼±æ€§ã®æ·±åˆ»åº¦å®šç¾©

| ãƒ¬ãƒ™ãƒ« | èª¬æ˜ | å¯¾å¿œæœŸé™ |
|--------|------|---------|
| ğŸ”´ **Critical** | ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã«å½±éŸ¿ã€ãƒ‡ãƒ¼ã‚¿æ¼æ´©ãƒ»ç ´å£Šã®å¯èƒ½æ€§ | 24æ™‚é–“ä»¥å†… |
| ğŸŸ  **High** | é‡è¦ãªæ©Ÿèƒ½ã«å½±éŸ¿ã€ä¸€éƒ¨ãƒ‡ãƒ¼ã‚¿ã®æ¼æ´©å¯èƒ½æ€§ | 1é€±é–“ä»¥å†… |
| ğŸŸ¡ **Medium** | é™å®šçš„ãªå½±éŸ¿ã€æ”»æ’ƒãŒå›°é›£ | 1ãƒ¶æœˆä»¥å†… |
| ğŸŸ¢ **Low** | è»½å¾®ãªå½±éŸ¿ã€æ”»æ’ƒæ¡ä»¶ãŒå³ã—ã„ | æ¬¡å›ãƒªãƒªãƒ¼ã‚¹æ™‚ |

---

## ä»˜éŒ²B: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç”¨èªé›†

| ç”¨èª | èª¬æ˜ |
|------|------|
| **CSRF** | Cross-Site Request Forgeryã€‚æ”»æ’ƒè€…ãŒè¢«å®³è€…ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ‚ªç”¨ã—ã¦æ„å›³ã—ãªã„æ“ä½œã‚’å®Ÿè¡Œã•ã›ã‚‹æ”»æ’ƒ |
| **XSS** | Cross-Site Scriptingã€‚æ‚ªæ„ã®ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’Webãƒšãƒ¼ã‚¸ã«æŒ¿å…¥ã™ã‚‹æ”»æ’ƒ |
| **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³** | SQLã‚¯ã‚¨ãƒªã«æ‚ªæ„ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ“ä½œã™ã‚‹æ”»æ’ƒ |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯** | ä»–äººã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç›—ã‚“ã§ãªã‚Šã™ã¾ã™æ”»æ’ƒ |
| **ã‚¯ãƒªãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚­ãƒ³ã‚°** | é€æ˜ãªiframeã‚’ä½¿ã£ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã—ãªã„ã‚¯ãƒªãƒƒã‚¯ã‚’èª˜å°ã™ã‚‹æ”»æ’ƒ |
| **ãƒ¬ãƒ¼ãƒˆåˆ¶é™** | ä¸€å®šæ™‚é–“å†…ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’åˆ¶é™ã™ã‚‹ä»•çµ„ã¿ |
| **ç›£æŸ»ãƒ­ã‚°** | ã‚·ã‚¹ãƒ†ãƒ æ“ä½œã®å±¥æ­´ã‚’è¨˜éŒ²ã—ã€ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ¤œçŸ¥ã™ã‚‹ãŸã‚ã®ãƒ­ã‚° |

---

**å ±å‘Šæ›¸ä½œæˆæ—¥**: 2026å¹´2æœˆ12æ—¥
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼äºˆå®š**: 2026å¹´5æœˆ12æ—¥ï¼ˆ3ãƒ¶æœˆå¾Œï¼‰
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
