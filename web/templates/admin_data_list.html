<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒ‡ãƒ¼ã‚¿ç®¡ç† - ç®¡ç†è€…</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .filter-box { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
        .filter-row { display: flex; gap: 15px; align-items: flex-end; }
        .filter-group { flex-grow: 1; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .filter-group select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        
        .data-section { margin-bottom: 50px; }
        .data-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section-title { margin: 0; font-size: 1.4em; color: #333; }
        
        .preview-table, .monitor-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .preview-table th, .monitor-table th { background-color: #f2f2f2; border: 1px solid #ddd; padding: 10px; text-align: left; }
        .preview-table td, .monitor-table td { border: 1px solid #ddd; padding: 10px; }

        .btn-preview { background-color: #17a2b8; color: white; border: none; padding: 10px 25px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-download { display: inline-block; background-color: #28a745; color: white; padding: 10px 20px; border-radius: 4px; text-decoration: none; font-weight: bold; }
        .btn-download:hover { background-color: #218838; }
    </style>
</head>
<body>

<div class="container admin-container">

    <nav class="breadcrumb">
        <a href="/admin" class="back-link">ç®¡ç†è€…ãƒ›ãƒ¼ãƒ </a>
        <span class="separator">|</span>
        <a href="/logout" class="nav-link">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </nav>

    <header class="page-header admin-header">
        <h1>ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ»å‡ºåŠ›</h1>
    </header>

    <section class="form-section">
        <div class="filter-box">
            <form method="GET" action="/admin/data">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>æˆæ¥­ (Class)</label>
                        <select name="class_id" id="classSelect" onchange="filterSessions()">
                            <option value="0">ã™ã¹ã¦ã®æˆæ¥­</option>
                            {{range .Classes}}
                                <option value="{{.ID}}" {{if eq $.SelectedClass .ID}}selected{{end}}>{{.ClassName}}</option>
                            {{end}}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>å®Ÿæ–½å› (Session)</label>
                        <select name="session_id" id="sessionSelect" disabled>
                            <option value="0">ã™ã¹ã¦ã®å›</option>
                            {{range .Sessions}}
                                <option value="{{.ID}}" data-class="{{.ClassID}}" {{if eq $.SelectedSess .ID}}selected{{end}}>{{.DisplayName}}</option>
                            {{end}}
                        </select>
                    </div>

                    <div>
                        <button type="submit" class="btn-preview">ğŸ” è¡¨ç¤º (Update Views)</button>
                    </div>
                </div>
            </form>
        </div>
    </section>


    <section class="data-section">
        <div class="data-header">
            <h2 class="section-title">â‘  å‚åŠ è€…ãƒªã‚¹ãƒˆ (Participants)</h2>
            <span style="color: #666;">è©²å½“ä»¶æ•°: {{len .PreviewData}} å</span>
        </div>

        {{if .PreviewData}}
            <div style="overflow-x: auto;">
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>æ°å</th>
                            <th>ä¸­å­¦æ ¡</th>
                            <th>æˆæ¥­</th>
                            <th>å®Ÿæ–½å›</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .PreviewData}}
                        <tr>
                            <td>{{.UserID}}</td>
                            <td>{{.StudentName}}</td>
                            <td>{{.SchoolName}}</td>
                            <td>{{.ClassName}}</td>
                            <td>{{.SessionTime}}</td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: right;">
                <a href="/admin/data/download?class_id={{.SelectedClass}}&session_id={{.SelectedSess}}" class="btn-download">
                    ğŸ“¥ å‚åŠ è€…åç°¿ CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>
        {{else}}
            <p style="text-align: center; color: #999; padding: 20px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        {{end}}
    </section>


    <section class="data-section">
        <div class="data-header">
            <h2 class="section-title">â‘¡ æˆæ¥­æƒ…å ±ãƒ»å—ä»˜çŠ¶æ³ (Class Info)</h2>
            <span style="color: #666;">è©²å½“ä»¶æ•°: {{len .Statuses}} ä»¶</span>
        </div>

        <table class="monitor-table">
            <thead>
                <tr>
                    <th>æ¨¡æ“¬æˆæ¥­å</th>
                    <th>å®Ÿæ–½å› (æ—¥æ™‚)</th>
                    <th>å ´æ‰€</th>
                    <th>æ‹…å½“æ•™è·å“¡</th>
                    <th>å®šå“¡</th>
                    <th>ç¾åœ¨ç”³è¾¼</th>
                </tr>
            </thead>
            <tbody>
                {{range .Statuses}}
                <tr>
                    <td>{{.ClassName}}</td>
                    <td>{{.SessionTime}}</td>
                    <td>{{.RoomName}}</td>
                    <td>{{.Instructors}}</td>
                    <td>{{.Capacity}}</td>
                    <td style="font-weight: bold;">{{.Count}} / {{.Capacity}}</td>
                </tr>
                {{else}}
                <tr><td colspan="6" style="text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
                {{end}}
            </tbody>
        </table>

        <div style="text-align: right;">
            <a href="/admin/data/download/classes?class_id={{.SelectedClass}}&session_id={{.SelectedSess}}" class="btn-download" style="background-color: #6c757d;">
                ğŸ“¥ æˆæ¥­æƒ…å ± CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
        </div>
    </section>

</div>

<script>
    function filterSessions() {
        const classSelect = document.getElementById('classSelect');
        const sessionSelect = document.getElementById('sessionSelect');
        const selectedClassID = classSelect.value;
        const options = sessionSelect.querySelectorAll('option');

        if (selectedClassID === "0") {
            sessionSelect.value = "0";
            sessionSelect.disabled = true;
            return;
        }

        sessionSelect.disabled = false;
        
        let currentVal = sessionSelect.value;
        let isCurrentValueValid = (currentVal === "0");

        options.forEach(opt => {
            if (opt.value === "0") {
                opt.style.display = ""; 
                return;
            }
            if (opt.dataset.class === selectedClassID) {
                opt.style.display = "";
                if (opt.value === currentVal) isCurrentValueValid = true;
            } else {
                opt.style.display = "none";
            }
        });

        if (!isCurrentValueValid) sessionSelect.value = "0";
    }

    window.addEventListener('DOMContentLoaded', filterSessions);
</script>

</body>
</html>
